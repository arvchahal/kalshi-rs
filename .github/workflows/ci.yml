name: CI

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  schedule:
    - cron: '0 3 * * 0'

jobs:
  unit-tests:
    name: Unit Tests (Serialization)
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule'

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Run unit tests (models serialization)
        run: |
          for dir in tests/*_test; do
            if [ -f "$dir/models_test.rs" ]; then
              module=$(basename "$dir")
              echo "Testing ${module}::models_test..."
              cargo test --test lib "${module}::models_test" -- --nocapture
            fi
          done

      - name: Check code compiles
        run: cargo check

  live-api-tests:
    name: Live API Tests (Weekly)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Setup credentials
        env:
          KALSHI_PRIVATE_KEY: ${{ secrets.KALSHI_PRIVATE_KEY }}
          KALSHI_API_KEY_ID: ${{ secrets.KALSHI_API_KEY_ID }}
        run: |
          echo "$KALSHI_PRIVATE_KEY" > kalshi_private.pem
          echo "KALSHI_API_KEY_ID=$KALSHI_API_KEY_ID" >> $GITHUB_ENV

      - name: Run live API tests (endpoints)
        run: |
          for dir in tests/*_test; do
            if [ -f "$dir/endpoints_test.rs" ]; then
              module=$(basename "$dir")
              echo "Testing ${module}::endpoints_test..."
              cargo test --test lib "${module}::endpoints_test" -- --nocapture || true
            fi
          done

      - name: Cleanup credentials
        if: always()
        run: rm -f kalshi_private.pem
