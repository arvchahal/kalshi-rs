  name: Test

  on:
    push:
      branches: [ master ]
    pull_request:
      branches: [ master ]
    schedule:
      - cron: '0 3 * * 0'

  jobs:
    build:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v3
        - uses: dtolnay/rust-toolchain@stable
        - name: Build
          run: cargo build --verbose
        - name: Cache build artifacts
          uses: actions/cache@v3
          with:
            path: target
            key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    test-unit:
      needs: build  # Runs after build succeeds
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v3
        - uses: dtolnay/rust-toolchain@stable
        - name: Run unit tests
          run: cargo test --lib --verbose

    test-integration:
      needs: build
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v3
        - uses: dtolnay/rust-toolchain@stable
        - name: Run integration tests (models serialization)
          run: |
            for dir in tests/*_test; do
              if [ -f "$dir/models_test.rs" ]; then
                module=$(basename "$dir")
                echo "Testing ${module}::models_test..."
                cargo test --test lib "${module}::models_test" -- --nocapture
              fi
            done

    test-live-api:
      needs: build
      runs-on: ubuntu-latest
      if: github.event_name == 'schedule'
      steps:
        - uses: actions/checkout@v3
        - uses: dtolnay/rust-toolchain@stable

        - name: Cache cargo registry
          uses: actions/cache@v4
          with:
            path: ~/.cargo/registry
            key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

        - name: Cache cargo index
          uses: actions/cache@v4
          with:
            path: ~/.cargo/git
            key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

        - name: Cache cargo build
          uses: actions/cache@v4
          with:
            path: target
            key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

        - name: Setup credentials
          env:
            KALSHI_PRIVATE_KEY: ${{ secrets.KALSHI_PRIVATE_KEY }}
            KALSHI_API_KEY_ID: ${{ secrets.KALSHI_API_KEY_ID }}
          run: |
            echo "$KALSHI_PRIVATE_KEY" > kalshi_private.pem
            echo "KALSHI_PK_FILE_PATH=kalshi_private.pem" >> $GITHUB_ENV
            echo "KALSHI_API_KEY_ID=$KALSHI_API_KEY_ID" >> $GITHUB_ENV

        - name: Run live API tests (endpoints)
          run: |
            for dir in tests/*_test; do
              if [ -f "$dir/endpoints_test.rs" ]; then
                module=$(basename "$dir")
                echo "Testing ${module}::endpoints_test..."
                cargo test --test lib "${module}::endpoints_test" -- --nocapture || true
              fi
            done

        - name: Cleanup credentials
          if: always()
          run: rm -f kalshi_private.pem

    lint:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v3
        - uses: dtolnay/rust-toolchain@stable
        - name: Install prettyplease-cli
          run: cargo install prettyplease-cli
        - name: Check formatting with prettyplease
          run: prettyplease-fmt --check $(find src tests examples -name "*.rs" 2>/dev/null)
        - name: Run clippy
          run: cargo clippy

    test-modules:
      runs-on: ubuntu-latest
      strategy:
        matrix:
          module: [markets, api_keys, exchange, auth]
      steps:
        - uses: actions/checkout@v3
        - uses: dtolnay/rust-toolchain@stable
        - name: Test ${{ matrix.module }} module
          run: cargo test --lib ${{ matrix.module }}